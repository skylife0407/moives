<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ja.movie.movie.mapper.MovieSQLMapper">
	
	<select id="getList" resultType="com.ja.movie.vo.MovieVo">
		select *
		from movie order by movie_no ASC
	</select>
	
	<!-- 유저 선호 장르 -->
	<select id="favorList" resultType="com.ja.movie.vo.MovieVo">
		<![CDATA[
		SELECT DISTINCT mv.* FROM USER_GENRE ug, MOVIE_GENRE mg, MOVIE mv
		WHERE ug.GENRECATEGORY_NO = mg.GENRE_CATEGORY_NO AND mg.MOVIE_NO = mv.MOVIE_NO AND ug.MEMBER_NO = #{member_no}
		AND rownum <= 12 order by dbms_random.value
		]]>
	</select>
	
	
	<!-- 박스오피스 -->
	<select id="boxOfficeList" resultType="com.ja.movie.vo.MovieVo">
		select * from movie
		<![CDATA[where movie_repRlsDate > sysdate - 31
		and movie_reprlsdate <= sysdate]]> 
		order by movie_reprlsdate DESC
	</select>

	

	<!-- 추천 -->
	<select id="movieRecommendList" resultType="com.ja.movie.vo.MovieVo">
	<![CDATA[
		SELECT t2.* FROM (
			SELECT t1.* FROM (
				SELECT m.*, (
					SELECT COUNT(*) FROM Movie_Like l
				    	WHERE l.movie_no = m.movie_no
				        ) as cnt
				        FROM Movie m
				    ) t1
				    ORDER BY t1.cnt DESC
				) t2
				WHERE cnt != 0
		]]> 
   </select>
   
   	<!-- 별점 -->
	<select id="movieStarList" resultType="com.ja.movie.vo.MovieVo">
		SELECT t2.* FROM (
		    SELECT t1.* FROM (
		        SELECT m.*, (
		            SELECT ROUND(AVG(ONELINEREPLY_STAR),2) FROM ONELINEREPLY o
		            WHERE o.movie_no = m.movie_no
		        ) as star
		        FROM Movie m
		    ) t1
		    WHERE t1.star IS NOT null
		    ORDER BY t1.star DESC 
		) t2
	</select>
	
	<!-- 별점받아오기 -->
	<select id="movieStarAvg" resultType="double">
		select ROUND(NVL(AVG(oneLineReply_star),0),2) as staravg  from OneLineReply
		WHERE movie_no = #{movie_no}
	</select>
	
</mapper>